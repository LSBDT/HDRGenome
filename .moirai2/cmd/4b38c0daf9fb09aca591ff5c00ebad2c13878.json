{"https://moirai2.github.io/schema/daemon/bash":["logFile=$project/log/genomecov.$case.txt","genomecov.pl $noIndel -o $tmpdir -m $stretchMode -t $topX -r $regionSize $table $case $chrominfo > $output 2> $logFile","output=`ls $tmpdir/*.txt`","filename=`basename $output`","echo \"INSERT $case->$project/genomecov#log->$logFile\""],"https://moirai2.github.io/schema/daemon/command/option":{"noIndel":"-d"},"https://moirai2.github.io/schema/daemon/input":["case","chrominfo","genome","noIndel","project","regionSize","stretchMode","table","topX"],"https://moirai2.github.io/schema/daemon/approximate/time":"1","https://moirai2.github.io/schema/daemon/output":"output","https://moirai2.github.io/schema/daemon/query/in":["$project->hdr#targetMode->DD","root->$project/vcftable->$table","root->$project/case->$case","$project->genomecov#noIndel->$noIndel","$project->genomecov#stretchMode->$stretchMode","$project->genomecov#topX->$topX","$project->genomecov#regionSize->$regionSize","$project->annotation#genome->$genome","$genome->chrominfo->$chrominfo"],"https://moirai2.github.io/schema/daemon/query/out":"$case->$project/genomecov->$output","https://moirai2.github.io/schema/daemon/dagdb":"db","https://moirai2.github.io/schema/daemon/script":{"https://moirai2.github.io/schema/daemon/script/code":["#!/usr/bin/perl","use strict 'vars';","use Cwd;","use File::Basename;","use File::Temp qw/tempfile tempdir/;","use FileHandle;","use Getopt::Std;","use IO::File;","use Time::localtime;","############################## HEADER ##############################","my ($program_name,$program_directory,$program_suffix)=fileparse($0);","$program_directory=Cwd::abs_path($program_directory);","my $program_path=\"$program_directory/$program_name\";","my $program_version=\"2022/08/27\";","############################## OPTIONS ##############################","use vars qw($opt_d $opt_h $opt_m $opt_o $opt_r $opt_t);","getopts('dhm:o:r:t:');","############################## HELP ##############################","sub help{","  print STDERR \"\\n\";","  print STDERR \"Command: $program_name [option] TABLE CASE GENOME\\n\";","  print STDERR \"Arguments:\\n\";","  print STDERR \" TABLE  Table from vcftable.pl\\n\";","  print STDERR \"  CASE  Case file/directory\\n\";","  print STDERR \"GENOME  Genome lengths\\n\";","  print STDERR \"Options:\\n\";","  print STDERR \"    -d  Exclude insertion/deletion\\n\";","  print STDERR \"    -m  hom/het stretch (default=hom)\\n\";","  print STDERR \"    -o  outdir (default=STDOUT)\\n\";","  print STDERR \"    -r  Region size (default=10,000bp)\\n\";","  print STDERR \"    -t  Pick top X (default=10)\\n\";","  print STDERR \"\\n\";","  print STDERR \"Author: akira.hasegawa\\@riken.jp\\n\";","  print STDERR \"Update: $program_version\\n\";","  print STDERR \"\\n\";","}","############################## MAIN ##############################","if($ARGV[0]eq\"sortsubs\"){sortSubs();exit();}","elsif(defined($opt_h)||scalar(@ARGV)<2){help();exit();}","my $tableFile=shift(@ARGV);","my $caseFile=shift(@ARGV);","my $genomeFile=shift(@ARGV);","my $basename=getBasename($caseFile);","my $noIndel=$opt_d;","my $stretchMode=defined($opt_m)?lc($opt_m):\"hom\";","my $regionSize=defined($opt_r)?$opt_r:10000;","my $topX=defined($opt_t)?$opt_t:10;","my $bedfile=createBed($tableFile,$basename,$genomeFile,$noIndel,$stretchMode,$regionSize);","my $groups=groupByDepth($bedfile);","my $writer=fileWriter($opt_o,$basename,$noIndel,$stretchMode,$regionSize,$topX);","pickTopX($writer,$topX,$groups);","############################## absolutePath ##############################","sub absolutePath{","\tmy $path=shift();","\tmy $directory=dirname($path);","\tmy $filename=basename($path);","\treturn Cwd::abs_path($directory).\"/$filename\";","}","############################## createBed ##############################","sub createBed{","  my $tableFile=shift();","  my $basename=shift();","  my $genomeFile=shift();","  my $noIndel=shift();","  my $stretchMode=shift();","  my $regionSize=shift();","  my $reader=openFile($tableFile);","  my $index=getColumnIndex($reader,$basename);","  my $mode=0;","  my $half=int($regionSize/2);","  if($stretchMode eq\"hom\"){$mode=2;}","  elsif($stretchMode eq\"het\"){$mode=1;}","  my ($fh,$tmpfile)=tempfile(DIR=>\"/tmp\",TEMPLATE=>\"XXXXXX\",SUFFIX=>\".bed\");","  while(<$reader>){","    chomp;","    my @tokens=split(/\\t/);","    my $chr=$tokens[0];","    my $pos=$tokens[1];","    my $flag=$tokens[$index];","    if(($flag&$mode)==0){next;}","    if($noIndel&&(($flag&4)>0||($flag&8)>0)){next;}","    my $start=$pos-$half;","    my $end=$pos+$half;","    print $fh \"$chr\\t$start\\t$end\\t$chr:$pos\\t$flag\\t.\\n\";","  }","  close($reader);","  close($fh);","  my ($fh2,$tmpfile2)=tempfile(DIR=>\"/tmp\",TEMPLATE=>\"XXXXXX\",SUFFIX=>\".bed\");","  close($fh2);","  system(\"sort -k1,1 -k2,2n -k3,3n $tmpfile > $tmpfile2\");","  #https://bedtools.readthedocs.io/en/latest/content/tools/genomecov.html","  my ($fh3,$tmpfile3)=tempfile(DIR=>\"/tmp\",TEMPLATE=>\"XXXXXX\",SUFFIX=>\".bed\");","  close($fh3);","  system(\"bedtools genomecov -i $tmpfile2 -g $genomeFile -bga > $tmpfile3\");","  unlink($tmpfile2);","  return $tmpfile3;","}","############################## fileWriter ##############################","sub fileWriter{","  my $outdir=shift();","  my $basename=shift();","  my $noIndel=shift();","  my $stretchMode=shift();","  my $regionSize=shift();","  my $topX=shift();","  if(!defined($outdir)){return IO::File->new(\">&STDOUT\");}","  mkdir($outdir);","  my $filename=\"$outdir/$basename.${stretchMode}_region${regionSize}_top${topX}\";","  if(defined($noIndel)){$filename.=\"_noindel\";}","  $filename.=\".txt\";","  return IO::File->new(\">$filename\");","}","############################## getBasename ##############################","sub getBasename{","  my $file=shift();","  my $basename=basename($file);","  if($basename=~/^(.+)\\.g\\.vcf$/i){$basename=$1}","  elsif($basename=~/^(.+)\\.vcf$/i){$basename=$1}","  elsif($basename=~/^(.+)\\.bcf$/i){$basename=$1}","  elsif($basename=~/^(.+)\\.avinput$/i){$basename=$1}","  return $basename;","}","############################## getColumnIndex ##############################","sub getColumnIndex{","  my $reader=shift();","  my $basename=shift();","  my $line=<$reader>;","  chomp($line);","  my @tokens=split(/\\t/,$line);","  my $index=-1;","  for(my $i=0;$i<scalar(@tokens);$i++){","    if($tokens[$i]eq$basename){$index=$i;}","  }","  return $index;","}","############################## getDate ##############################","sub getDate{","\tmy $delim=shift();","\tmy $time=shift();","\tif(!defined($delim)){$delim=\"\";}","\tif(!defined($time)||$time eq \"\"){$time=localtime();}","\telse{$time=localtime($time);}","\tmy $year=$time->year+1900;","\tmy $month=$time->mon+1;","\tif($month<10){$month=\"0\".$month;}","\tmy $day=$time->mday;","\tif($day<10){$day=\"0\".$day;}","\treturn $year.$delim.$month.$delim.$day;","}","############################## groupByDepth ##############################","sub groupByDepth{","  my $file=shift();","  my $reader=openFile($file);","  my @depths=();","  my $total=0;","  my $currentChr;","  my $currentStart;","  my $currentEnd;","  my $currentDepth;","  my @array=();","  while(<$reader>){","    chomp;","    my ($chr,$start,$end,$depth)=split(/\\t/);","    if($depth==0){","      if(defined($currentChr)&&$currentDepth>1){push(@array,[$currentChr,$currentStart,$currentEnd,$currentDepth]);}","      $currentChr=undef;","      $currentStart=undef;","      $currentEnd=undef;","      $currentDepth=undef;","      next;","    }","    if(!defined($currentChr)){","      $currentChr=$chr;","      $currentStart=$start;","      $currentEnd=$end;","      $currentDepth=$depth;","      next;","    }","    $currentEnd=$end;","    if($currentDepth<$depth){$currentDepth=$depth;}","  }","  if(defined($currentChr)&&$currentDepth>1){push(@array,[$currentChr,$currentStart,$currentEnd,$currentDepth]);}","  close($reader);","  return \\@array;","}","############################## listFiles ##############################","sub listFiles{","\tmy @input_directories=@_;","\tmy $file_suffix=shift(@input_directories);","\tmy @input_files=();","\tforeach my $input_directory (@input_directories){","\t\t$input_directory=absolutePath($input_directory);","\t\tif(-f $input_directory){push(@input_files,$input_directory);next;}","\t\telsif(-l $input_directory){push(@input_files,$input_directory);next;}","\t\topendir(DIR,$input_directory);","\t\tforeach my $file(readdir(DIR)){","\t\t\tif($file eq \".\"){next;}","\t\t\tif($file eq \"..\") {next;}","\t\t\tif($file eq \"\"){next;}","\t\t\t$file=\"$input_directory/$file\";","\t\t\tif(-d $file){next;}","\t\t\telsif($file!~/$file_suffix$/){next;}","\t\t\tpush(@input_files,$file);","\t\t}","\t\tclosedir(DIR);","\t}","\treturn sort(@input_files);","}","############################## openFile ##############################","sub openFile{","\tmy $path=shift();","\tif($path=~/^(.+\\@.+)\\:(.+)$/){","\t\tif($path=~/\\.gz(ip)?$/){return IO::File->new(\"ssh $1 'gzip -cd $2'|\");}","\t\telsif($path=~/\\.bz(ip)?2$/){return IO::File->new(\"ssh $1 'bzip2 -cd $2'|\");}","\t\telsif($path=~/\\.bam$/){return IO::File->new(\"ssh $1 'samtools view $2'|\");}","\t\telse{return IO::File->new(\"ssh $1 'cat $2'|\");}","\t}else{","\t\tif($path=~/\\.gz(ip)?$/){return IO::File->new(\"gzip -cd $path|\");}","\t\telsif($path=~/\\.bz(ip)?2$/){return IO::File->new(\"bzip2 -cd $path|\");}","\t\telsif($path=~/\\.bam$/){return IO::File->new(\"samtools view $path|\");}","\t\telse{return IO::File->new($path);}","\t}","}","############################## pickTopX ##############################","sub pickTopX{","  my $writer=shift();","  my $topX=shift();","  my $groups=shift();","  my $outdir=shift();","  my $hash={};","  for(my $i=0;$i<scalar(@{$groups});$i++){","    my ($chr,$start,$end,$depth)=@{$groups->[$i]};","    push(@{$hash->{$depth}},$i);","  }","  my ($fh,$tmpfile)=tempfile(DIR=>\"/tmp\",TEMPLATE=>\"XXXXXX\",SUFFIX=>\".bed\");","  my @keys=sort{$b<=>$a}keys(%{$hash});","  my $total=0;","  foreach my $key(@keys){","    my @indeces=@{$hash->{$key}};","    foreach my $index(@indeces){","      my $group=$groups->[$index];","      print $fh join(\"\\t\",@{$group}).\"\\n\";","    }","    $total+=scalar(@indeces);","    if($total>=$topX){last;}","  }","  close($fh);","  my ($fh2,$tmpfile2)=tempfile(DIR=>\"/tmp\",TEMPLATE=>\"XXXXXX\",SUFFIX=>\".bed\");","  close($fh2);","  system(\"sort -k1,1 -k2,2n -k3,3n $tmpfile > $tmpfile2\");","  my $reader=openFile($tmpfile2);","  print $writer \"#Chr\\tStart\\tEnd\\tDepth\\n\";","  while(<$reader>){chomp;print $writer \"$_\\n\";}","  close($reader);","  close($writer);","}","############################## printTable ##############################","sub printTable{","\tmy @out=@_;","\tmy $return_type=$out[0];","\tif(lc($return_type) eq \"print\"){$return_type=0;shift(@out);}","\telsif(lc($return_type) eq \"array\"){$return_type=1;shift(@out);}","\telsif(lc($return_type) eq \"stderr\"){$return_type=2;shift(@out);}","\telse{$return_type= 2;}","\tprintTableSub($return_type,\"\",@out);","}","sub printTableSub{","\tmy @out=@_;","\tmy $return_type=shift(@out);","\tmy $string=shift(@out);","\tmy @output=();","\tfor(@out){","\t\tif(ref( $_ ) eq \"ARRAY\"){","\t\t\tmy @array=@{$_};","\t\t\tmy $size=scalar(@array);","\t\t\tif($size==0){","\t\t\t\tif($return_type==0){print $string.\"[]\\n\";}","\t\t\t\telsif($return_type==1){push(@output,$string.\"[]\");}","\t\t\t\telsif($return_type==2){print STDERR $string.\"[]\\n\";}","\t\t\t}else{","\t\t\t\tfor(my $i=0;$i<$size;$i++){push(@output,printTableSub($return_type,$string.\"[$i]=>\\t\",$array[$i]));}","\t\t\t}","\t\t} elsif(ref($_)eq\"HASH\"){","\t\t\tmy %hash=%{$_};","\t\t\tmy @keys=sort{$a cmp $b}keys(%hash);","\t\t\tmy $size=scalar(@keys);","\t\t\tif($size==0){","\t\t\t\tif($return_type==0){print $string.\"{}\\n\";}","\t\t\t\telsif($return_type==1){push( @output,$string.\"{}\");}","\t\t\t\telsif($return_type==2){print STDERR $string.\"{}\\n\";}","\t\t\t}else{","\t\t\t\tforeach my $key(@keys){push(@output,printTableSub($return_type,$string.\"{$key}=>\\t\",$hash{$key}));}","\t\t\t}","\t\t}elsif($return_type==0){print \"$string\\\"$_\\\"\\n\";}","\t\telsif($return_type==1){push( @output,\"$string\\\"$_\\\"\");}","\t\telsif($return_type==2){print STDERR \"$string\\\"$_\\\"\\n\";}","\t}","\treturn wantarray?@output:$output[0];","}","############################## sortSubs ##############################","sub sortSubs{","\tmy $path=\"$program_directory/$program_name\";","\tmy $reader=openFile($path);","\tmy @headers=();","\tmy $name;","\tmy $blocks={};","\tmy $block=[];","\tmy $date=getDate(\"/\");","\tmy @orders=();","\twhile(<$reader>){","\t\tchomp;s/\\r//g;","\t\tif(/^#{30}\\s*(\\S+)\\s*#{30}$/){","\t\t\t$name=$1;","\t\t\tif($name!~/^[A-Z]+$/){push(@{$block},$_);last;}","\t\t}elsif(/^my \\$program_version=\\\"\\S+\\\";/){$_=\"my \\$program_version=\\\"$date\\\";\";}","\t\tpush(@headers,$_);","\t}","\twhile(<$reader>){","\t\tchomp;s/\\r//g;","\t\tif(/^#{30}\\s*(\\S+)\\s*#{30}$/){","\t\t\t$blocks->{$name}=$block;","\t\t\tpush(@orders,$name);","\t\t\t$name=$1;","\t\t\t$block=[];","\t\t}","\t\tpush(@{$block},$_);","\t}","\tclose($reader);","\tif(defined($name)){$blocks->{$name}=$block;push(@orders,$name);}","\tmy ($writer,$file)=tempfile(DIR=>\"/tmp\",SUFFIX=>\".pl\");","\tforeach my $line(@headers){print $writer \"$line\\n\";}","\tforeach my $key(sort{$a cmp $b}@orders){foreach my $line(@{$blocks->{$key}}){print $writer \"$line\\n\";}}","\tclose($writer);","\treturn system(\"mv $file $path\");","}"],"https://moirai2.github.io/schema/daemon/script/name":"genomecov.pl"},"https://moirai2.github.io/schema/daemon/sleeptime":"60","https://moirai2.github.io/schema/daemon/userdefined":{"output":"$project/genomecov/$filename"}}
