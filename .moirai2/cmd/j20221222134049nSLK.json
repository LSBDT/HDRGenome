{"https://moirai2.github.io/schema/daemon/bash":["annotation.pl $stats $cytoband $gencode $chrominfo js/tablesort-min.js > $html","filename=`basename $stats .out`"],"https://moirai2.github.io/schema/daemon/input":["chrominfo","cytoband","gencode","genome","hdr","project","stats"],"https://moirai2.github.io/schema/daemon/output":"html","https://moirai2.github.io/schema/daemon/query/in":["$project->annotation#genome->$genome","$genome->chrominfo->$chrominfo","$genome->cytoband->$cytoband","$genome->gencode->$gencode","$hdr->$project/stats->$stats"],"https://moirai2.github.io/schema/daemon/query/out":"$stats->$project/stats#html->$html","https://moirai2.github.io/schema/daemon/rdfdb":"db","https://moirai2.github.io/schema/daemon/script":{"https://moirai2.github.io/schema/daemon/script/code":["#!/usr/bin/perl","use strict 'vars';","use Cwd;","use File::Basename;","use File::Temp qw/tempfile tempdir/;","use FileHandle;","use Getopt::Std;","use IO::File;","use Time::localtime;","############################## HEADER ##############################","my ($program_name,$program_directory,$program_suffix)=fileparse($0);","$program_directory=Cwd::abs_path($program_directory);","my $program_path=\"$program_directory/$program_name\";","my $program_version=\"2022/08/27\";","############################## OPTIONS ##############################","use vars qw($opt_h);","getopts('h');","############################## HELP ##############################","sub help{","  print STDERR \"\\n\";","  print STDERR \"Command: $program_name [option] STATS BED GENOME\\n\";","  print STDERR \"Arguments:\\n\";","  print STDERR \" STATS  Result from statdeRSl or maxstat\\n\";","  print STDERR \"   BED  BED file with gene locations\\n\";","  print STDERR \"GENOME  GENOME length file with gene locations\\n\";","  print STDERR \"\\n\";","  print STDERR \"Author: akira.hasegawa\\@riken.jp\\n\";","  print STDERR \"Update: $program_version\\n\";","  print STDERR \"\\n\";","}","############################## MAIN ##############################","if($ARGV[0]eq\"sortsubs\"){sortSubs();exit();}","elsif(defined($opt_h)||scalar(@ARGV)<2){help();exit();}","my $statsFile=shift(@ARGV);","my $telomereFile=shift(@ARGV);","my $annotationFile=shift(@ARGV);","my $genomeFile=shift(@ARGV);","my $jsFile=shift(@ARGV);","my $assembly=basename($genomeFile,\".genome\");","my ($program,$bedFile,$results)=readStats($statsFile);","intersectTelomere($results,$bedFile,$telomereFile);","findClosest($results,$bedFile,$annotationFile,$genomeFile);","printResult($results,$program,$assembly,$jsFile);","############################## absolutePath ##############################","sub absolutePath{","\tmy $path=shift();","\tmy $directory=dirname($path);","\tmy $filename=basename($path);","\treturn Cwd::abs_path($directory).\"/$filename\";","}","############################## findClosest ##############################","sub findClosest{","\tmy $results=shift();","\tmy $bedA=shift();","\tmy $bedB=shift();","\tmy $genomeFile=shift();","\tmy ($fh,$tmpfile)=tempfile(DIR=>\"/tmp\",TEMPLATE=>\"XXXXXX\",SUFFIX=>\".txt\");","\tclose($fh);","\tsystem(\"bedtools closest -g $genomeFile -D ref -a $bedA -b $bedB>$tmpfile\");","\tmy $reader=openFile($tmpfile);","\twhile(<$reader>){","\t\tchomp;","\t\tmy @token=split(/\\t/);","\t\tmy $id=$token[3];","\t\tmy $gene=$token[9];","\t\tmy $distance=$token[12];","\t\tif($id=~/^id(\\d+)$/){","\t\t$id=$1;","\t\tpush(@{$results->[$id]->[13]},[$gene,$distance]);","\t\t}","\t}","\tclose($reader);","}","############################## getDate ##############################","sub getDate{","\tmy $delim=shift();","\tmy $time=shift();","\tif(!defined($delim)){$delim=\"\";}","\tif(!defined($time)||$time eq \"\"){$time=localtime();}","\telse{$time=localtime($time);}","\tmy $year=$time->year+1900;","\tmy $month=$time->mon+1;","\tif($month<10){$month=\"0\".$month;}","\tmy $day=$time->mday;","\tif($day<10){$day=\"0\".$day;}","\treturn $year.$delim.$month.$delim.$day;","}","############################## intersectTelomere ##############################","sub intersectTelomere{","\tmy $results=shift();","\tmy $bedA=shift();","\tmy $bedB=shift();","\tif(scalar(@{$results})==0){return;}","\tmy ($fh,$tmpfile)=tempfile(DIR=>\"/tmp\",TEMPLATE=>\"XXXXXX\",SUFFIX=>\".txt\");","\tclose($fh);","\tsystem(\"bedtools intersect -a $bedA -b $bedB > $tmpfile\");","\tmy $reader=openFile($tmpfile);","\twhile(<$reader>){","\t\tchomp;","\t\tmy @token=split(/\\t/);","\t\tmy $id=$token[3];","\t\tif($id=~/^id(\\d+)$/){","\t\t\t$id=$1;","\t\t\tpush(@{$results->[$id]->[13]},[\"telomere\",0]);","\t\t}","\t}","\tclose($reader);","\tunlink($tmpfile);","}","############################## listFiles ##############################","sub listFiles{","\tmy @input_directories=@_;","\tmy $file_suffix=shift(@input_directories);","\tmy @input_files=();","\tforeach my $input_directory (@input_directories){","\t\t$input_directory=absolutePath($input_directory);","\t\tif(-f $input_directory){push(@input_files,$input_directory);next;}","\t\telsif(-l $input_directory){push(@input_files,$input_directory);next;}","\t\topendir(DIR,$input_directory);","\t\tforeach my $file(readdir(DIR)){","\t\t\tif($file eq \".\"){next;}","\t\t\tif($file eq \"..\") {next;}","\t\t\tif($file eq \"\"){next;}","\t\t\t$file=\"$input_directory/$file\";","\t\t\tif(-d $file){next;}","\t\t\telsif($file!~/$file_suffix$/){next;}","\t\t\tpush(@input_files,$file);","\t\t}","\t\tclosedir(DIR);","\t}","\treturn sort(@input_files);","}","############################## openFile ##############################","sub openFile{","\tmy $path=shift();","\tif($path=~/^(.+\\@.+)\\:(.+)$/){","\t\tif($path=~/\\.gz(ip)?$/){return IO::File->new(\"ssh $1 'gzip -cd $2'|\");}","\t\telsif($path=~/\\.bz(ip)?2$/){return IO::File->new(\"ssh $1 'bzip2 -cd $2'|\");}","\t\telsif($path=~/\\.bam$/){return IO::File->new(\"ssh $1 'samtools view $2'|\");}","\t\telse{return IO::File->new(\"ssh $1 'cat $2'|\");}","\t}else{","\t\tif($path=~/\\.gz(ip)?$/){return IO::File->new(\"gzip -cd $path|\");}","\t\telsif($path=~/\\.bz(ip)?2$/){return IO::File->new(\"bzip2 -cd $path|\");}","\t\telsif($path=~/\\.bam$/){return IO::File->new(\"samtools view $path|\");}","\t\telse{return IO::File->new($path);}","\t}","}","############################## printResult ##############################","sub printResult{","\tmy $results=shift();","\tmy $program=shift();","\tmy $assembly=shift();","\tmy $jsFile=shift();","\t#https://neil.fraser.name/software/tablesort/","\tif(defined($jsFile)){","\t\tprint \"<script>\\n\";","\t\tmy $reader=openFile($jsFile);","\t\twhile(<$reader>){print;}","\t\tprint \"</script>\\n\";","\t}","\tprint \"<style>\\n\";","\tprint \"table,td,th{border: 2px #000000 solid;}\\n\";","\tprint \"</style>\\n\";","\tprint \"<table>\\n\";","\tprint \"<thead>\\n<tr><th class=\\\"num\\\">Group_1</th><th class=\\\"num\\\">Group_2</th><th class=\\\"num\\\">n1</th><th class=\\\"num\\\">n2</th><th class=\\\"num\\\">Teststat</th><th class=\\\"num\\\">n</th><th class=\\\"num\\\">p</th><th class=\\\"case\\\">genome</th><th class=\\\"case\\\">mH</th><th class=\\\"num\\\">rank</th><th class=\\\"num\\\">Line</th><th class=\\\"case\\\">annotation</th></tr>\\n</thead>\\n\";","\tprint \"<tbody>\\n\";","\tforeach my $result(@{$results}){","\t\tmy $group_1=$result->[0];","\t\tmy $group_2=$result->[1];","\t\tmy $n1=$result->[2];","\t\tmy $n2=$result->[3];","\t\tmy $teststat=$result->[4];","\t\tmy $n=$result->[5];","\t\tmy $p=$result->[6];","\t\tmy $chr=($program eq \"statdel\")?$result->[7]:$result->[8];","\t\tmy $start_bp=($program eq \"statdel\")?$result->[8]:$result->[9]-100;","\t\tmy $end_bp=($program eq \"statdel\")?$result->[9]:$result->[9]+100;","\t\tmy $genome=\" <a href=\\\"https://genome.ucsc.edu/cgi-bin/hgTracks?db=$assembly&lastVirtModeType=default&lastVirtModeExtraState=&virtModeType=default&virtMode=0&nonVirtPosition=&position=$chr%3A${start_bp}%2D${end_bp}\\\">$chr:$start_bp-$end_bp</a>\";","\t\tmy $mH=$result->[10];","\t\tmy $rank=$result->[11];","\t\tmy $line=$result->[12];","\t\tmy $annotation=$result->[13];","\t\tprint \"<tr><td>$group_1</td><td>$group_2</td><td>$n1</td><td>$n2</td><td>$teststat</td><td>$n</td><td>$p</td><td>$genome</td><td>$mH</td><td>$rank</td><td>$line</td>\";","\t\tmy $line=shift();","\t\tforeach my $ann(@{$annotation}){","\t\t\tmy ($gene,$dist)=@{$ann};","\t\t\tif(defined($line)){$line.=\".\";}","\t\t\tif($gene ne \"telomere\"){$gene=\" <a href=\\\"https://www.genecards.org/cgi-bin/carddisp.pl?gene=$gene\\\">$gene</a>\"}","\t\t\t$line.=\"$gene($dist)\";","\t\t}","\t\tprint \"<td>$line</td>\";","\t\tprint \"</tr>\\n\";","\t}","\tprint \"<tbody>\\n\";","\tprint \"<table>\\n\";","}","############################## printTable ##############################","sub printTable{","\tmy @out=@_;","\tmy $return_type=$out[0];","\tif(lc($return_type) eq \"print\"){$return_type=0;shift(@out);}","\telsif(lc($return_type) eq \"array\"){$return_type=1;shift(@out);}","\telsif(lc($return_type) eq \"stderr\"){$return_type=2;shift(@out);}","\telse{$return_type= 2;}","\tprintTableSub($return_type,\"\",@out);","}","sub printTableSub{","\tmy @out=@_;","\tmy $return_type=shift(@out);","\tmy $string=shift(@out);","\tmy @output=();","\tfor(@out){","\t\tif(ref( $_ ) eq \"ARRAY\"){","\t\t\tmy @array=@{$_};","\t\t\tmy $size=scalar(@array);","\t\t\tif($size==0){","\t\t\t\tif($return_type==0){print $string.\"[]\\n\";}","\t\t\t\telsif($return_type==1){push(@output,$string.\"[]\");}","\t\t\t\telsif($return_type==2){print STDERR $string.\"[]\\n\";}","\t\t\t}else{","\t\t\t\tfor(my $i=0;$i<$size;$i++){push(@output,printTableSub($return_type,$string.\"[$i]=>\\t\",$array[$i]));}","\t\t\t}","\t\t} elsif(ref($_)eq\"HASH\"){","\t\t\tmy %hash=%{$_};","\t\t\tmy @keys=sort{$a cmp $b}keys(%hash);","\t\t\tmy $size=scalar(@keys);","\t\t\tif($size==0){","\t\t\t\tif($return_type==0){print $string.\"{}\\n\";}","\t\t\t\telsif($return_type==1){push( @output,$string.\"{}\");}","\t\t\t\telsif($return_type==2){print STDERR $string.\"{}\\n\";}","\t\t\t}else{","\t\t\t\tforeach my $key(@keys){push(@output,printTableSub($return_type,$string.\"{$key}=>\\t\",$hash{$key}));}","\t\t\t}","\t\t}elsif($return_type==0){print \"$string\\\"$_\\\"\\n\";}","\t\telsif($return_type==1){push( @output,\"$string\\\"$_\\\"\");}","\t\telsif($return_type==2){print STDERR \"$string\\\"$_\\\"\\n\";}","\t}","\treturn wantarray?@output:$output[0];","}","############################## readStats ##############################","sub readStats{","\tmy $file=shift();","\tmy $reader=openFile($file);","\tmy @columns;","\tmy $program;","\twhile(<$reader>){","\t\t#Var Group_1 Group_2    n1    n2 Teststat      R      p chr   position median HDR   rank","\t\t#Group_1\tGroup_2\tn1\tn2\tTeststat\tn\tp\tchr\tstart_bp\tend_bp\tmH\trank\tLine","\t\tif(/Var Group_1/){chomp;@columns=split(/\\s+/);$program=\"maxstatRS\";last;}","\t\tif(/Group_1/){chomp;@columns=split(/\\t/);$program=\"statdel\";last;}","\t}","\tmy ($fh,$tmpfile)=tempfile(DIR=>\"/tmp\",TEMPLATE=>\"XXXXXX\",SUFFIX=>\".bed\");","\tmy $index=0;","\tmy @results=();","\tif($program eq \"statdel\"){","\t\twhile(<$reader>){","\t\t\tif(/^\\s+$/){last;}","\t\t\tif(/Note:/){last;}","\t\t\tchomp;","\t\t\tmy @tokens=split(/\\t/);","\t\t\tpush(@results,\\@tokens);","\t\t\tmy $chr=$tokens[7];","\t\t\tmy $start=$tokens[8];","\t\t\tmy $end=$tokens[9];","\t\t\tmy $name=\"id$index\";","\t\t\tprint $fh \"$chr\\t$start\\t$end\\t$name\\t0\\t.\\n\";","\t\t\t$index++;","\t\t}","\t}elsif($program eq \"maxstatRS\"){","\t\twhile(<$reader>){","\t\t\tif(/^\\s+$/){last;}","\t\t\tif(/Note:/){last;}","\t\t\tchomp;","\t\t\tmy @tokens=split(/\\t/);","\t\t\tpush(@results,\\@tokens);","\t\t\tmy $chr=$tokens[8];","\t\t\tmy $start=$tokens[9];","\t\t\tmy $name=\"id$index\";","\t\t\tprint $fh \"$chr\\t$start\\t$start\\t$name\\t0\\t.\\n\";","\t\t\t$index++;","\t\t}","\t}","\tclose($fh);","\tmy ($fh2,$tmpfile2)=tempfile(DIR=>\"/tmp\",TEMPLATE=>\"XXXXXX\",SUFFIX=>\".bed\");","\tclose($fh2);","\tsystem(\"sort -k1,1 -k2,2n -k3,3n $tmpfile > $tmpfile2\");","\treturn ($program,$tmpfile2,\\@results);","}","############################## sortSubs ##############################","sub sortSubs{","\tmy $path=\"$program_directory/$program_name\";","\tmy $reader=openFile($path);","\tmy @headers=();","\tmy $name;","\tmy $blocks={};","\tmy $block=[];","\tmy $date=getDate(\"/\");","\tmy @orders=();","\twhile(<$reader>){","\t\tchomp;s/\\r//g;","\t\tif(/^#{30}\\s*(\\S+)\\s*#{30}$/){","\t\t\t$name=$1;","\t\t\tif($name!~/^[A-Z]+$/){push(@{$block},$_);last;}","\t\t}elsif(/^my \\$program_version=\\\"\\S+\\\";/){$_=\"my \\$program_version=\\\"$date\\\";\";}","\t\tpush(@headers,$_);","\t}","\twhile(<$reader>){","\t\tchomp;s/\\r//g;","\t\tif(/^#{30}\\s*(\\S+)\\s*#{30}$/){","\t\t\t$blocks->{$name}=$block;","\t\t\tpush(@orders,$name);","\t\t\t$name=$1;","\t\t\t$block=[];","\t\t}","\t\tpush(@{$block},$_);","\t}","\tclose($reader);","\tif(defined($name)){$blocks->{$name}=$block;push(@orders,$name);}","\tmy ($writer,$file)=tempfile(DIR=>\"/tmp\",SUFFIX=>\".pl\");","\tforeach my $line(@headers){print $writer \"$line\\n\";}","\tforeach my $key(sort{$a cmp $b}@orders){foreach my $line(@{$blocks->{$key}}){print $writer \"$line\\n\";}}","\tclose($writer);","\treturn system(\"mv $file $path\");","}"],"https://moirai2.github.io/schema/daemon/script/name":"annotation.pl"},"https://moirai2.github.io/schema/daemon/userdefined":{"html":"$project/html/$filename.html"}}
